[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Replication Code",
    "section": "",
    "text": "Show code\n# Load Packages\nlibrary(tidyverse)\nlibrary(lmtest)\nlibrary(sandwich)\nlibrary(fixest)\nlibrary(did)\nlibrary(panelView)\nlibrary(car)\nlibrary(showtext)\nlibrary(grid)\nlibrary(data.table)\nlibrary(FNN)\nlibrary(stringr)\nlibrary(plm)\nlibrary(scales)\nlibrary(modelsummary)\nlibrary(devtools)\nlibrary(foreign)\nlibrary(stargazer) \nlibrary(effectsize)\nlibrary(MASS)\nlibrary(marginaleffects)\nlibrary(broom)\nlibrary(readxl)\nlibrary(igraph)\nlibrary(tidygraph)\nlibrary(ggraph)\nlibrary(patchwork)\nlibrary(showtext)\nlibrary(httr2)\nlibrary(jsonlite)\nlibrary(purrr)\nlibrary(openai)\n\n\n\n\nShow code\n# Function for cleaning the data (provided by GSS)\n read.dct &lt;- function(dct, labels.included = \"yes\") {\n      temp &lt;- readLines(dct)\n      temp &lt;- temp[grepl(\"_column\", temp)]\n      switch(labels.included,\n             yes = {\n                 pattern &lt;- \"_column\\\\(([0-9]+)\\\\)\\\\s+([a-z0-9]+)\\\\s+(.*)\\\\s+%([0-9]+)[a-z]\\\\s+(.*)\"\n                 classes &lt;- c(\"numeric\", \"character\", \"character\", \"numeric\", \"character\")\n                 N &lt;- 5\n                 NAMES &lt;- c(\"StartPos\", \"Str\", \"ColName\", \"ColWidth\", \"ColLabel\")\n             },\n             no = {\n                 pattern &lt;- \"_column\\\\(([0-9]+)\\\\)\\\\s+([a-z0-9]+)\\\\s+(.*)\\\\s+%([0-9]+).*\"\n                 classes &lt;- c(\"numeric\", \"character\", \"character\", \"numeric\")\n                 N &lt;- 4\n                 NAMES &lt;- c(\"StartPos\", \"Str\", \"ColName\", \"ColWidth\")\n             })\n      temp_metadata &lt;- setNames(lapply(1:N, function(x) {\n          out &lt;- gsub(pattern, paste(\"\\\\\", x, sep = \"\"), temp)\n          out &lt;- gsub(\"^\\\\s+|\\\\s+$\", \"\", out)\n          out &lt;- gsub('\\\"', \"\", out, fixed = TRUE)\n          class(out) &lt;- classes[x] ; out }), NAMES)\n      temp_metadata[[\"ColName\"]] &lt;- make.names(gsub(\"\\\\s\", \"\", temp_metadata[[\"ColName\"]]))\n      temp_metadata\n  }\n\n  read.dat &lt;- function(dat, metadata_var, labels.included = \"yes\") {\n      read.table(dat, col.names = metadata_var[[\"ColName\"]])\n  }\n\n# Load the data\nGSS_metadata &lt;- read.dct(\"GSS.dct\")\nGSS_ascii &lt;- read.dat(\"GSS.dat\", GSS_metadata)\nattr(GSS_ascii, \"col.label\") &lt;- GSS_metadata[[\"ColLabel\"]]\nGSS &lt;- GSS_ascii"
  },
  {
    "objectID": "index.html#create-weighted-network-measure",
    "href": "index.html#create-weighted-network-measure",
    "title": "Replication Code",
    "section": "Create Weighted Network Measure",
    "text": "Create Weighted Network Measure\n\n\nShow code\n# Weight networks by the intensity of contact\ndata3 &lt;- data3 |&gt;\n  rowwise() |&gt;\n  mutate(\n    weighted_cowork = if (!is.na(numgiven) && numgiven &gt; 0) {\n\n      cw &lt;- c(cowork1, cowork2, cowork3, cowork4, cowork5)[1:numgiven]\n      tk &lt;- c(talkto1, talkto2, talkto3, talkto4, talkto5)[1:numgiven]\n\n      num &lt;- sum(cw * tk, na.rm = TRUE)\n      den &lt;- sum(tk, na.rm = TRUE)\n\n      if (den &gt; 0) num / den else NA_real_\n\n    } else {\n      NA_real_\n    }\n  ) |&gt;\n  ungroup()"
  },
  {
    "objectID": "index.html#match-by-occ-10-titles",
    "href": "index.html#match-by-occ-10-titles",
    "title": "Replication Code",
    "section": "Match By OCC 10 titles",
    "text": "Match By OCC 10 titles\n\n\nShow code\n# Official Census 2010 occupation code list (with crosswalk file)\nocc_url &lt;- \"https://www2.census.gov/programs-surveys/demo/guidance/industry-occupation/2010-occ-codes-with-crosswalk-from-2002-2011.xls\"\n\ntmp &lt;- tempfile(fileext = \".xls\")\ndownload.file(occ_url, tmp, mode = \"wb\")\n\n# Read the Excel and keep the 2010 code + title columns\nocc_lu_raw &lt;- read_excel(tmp)\n\nocc10_lu &lt;- occ_lu_raw |&gt;\n  transmute(\n    occ10_code  = str_trim(as.character(`...3`)),\n    occ10_title = str_squish(as.character(`US Census Bureau`))\n  ) |&gt;\n  filter(str_detect(occ10_code, \"^\\\\d{4}$\")) |&gt;\n  mutate(\n    occ10_code = as.integer(occ10_code)\n  )\n\n# join onto your data \ndata3 &lt;- data3 |&gt;\n  left_join(occ10_lu, by = \"occ10_code\")"
  },
  {
    "objectID": "index.html#create-isco-1-digit-and-2-digit-labels",
    "href": "index.html#create-isco-1-digit-and-2-digit-labels",
    "title": "Replication Code",
    "section": "Create ISCO 1-Digit and 2-Digit Labels",
    "text": "Create ISCO 1-Digit and 2-Digit Labels\n\n\nShow code\n# BY 1-DIGIT OCC CODE\nisco88_1digit &lt;- tibble::tribble(\n  ~isco1, ~isco1_title,\n  0, \"Armed forces\",\n  1, \"Legislators, senior officials and managers\",\n  2, \"Professionals\",\n  3, \"Technicians and associate professionals\",\n  4, \"Clerks\",\n  5, \"Service workers and shop and market sales workers\",\n  6, \"Skilled agricultural and fishery workers\",\n  7, \"Craft and related trades workers\",\n  8, \"Plant and machine operators and assemblers\",\n  9, \"Elementary occupations\"\n)\n\ndata3 &lt;- data3 |&gt;\n  left_join(isco88_1digit, by = \"isco1\")\n\n\n\n# BY 2-DIGIT OCC CODE\n# ISCO-88: 2-digit sub-major groups\nisco88_2digit &lt;- tibble::tribble(\n  ~isco2, ~isco2_title,\n  11, \"Legislators and senior officials\",\n  12, \"Corporate managers\",\n  13, \"General managers\",\n  21, \"Physical, mathematical and engineering science professionals\",\n  22, \"Life science and health professionals\",\n  23, \"Teaching professionals\",\n  24, \"Other professionals\",\n  31, \"Physical and engineering science associate professionals\",\n  32, \"Life science and health associate professionals\",\n  33, \"Teaching associate professionals\",\n  34, \"Other associate professionals\",\n  41, \"Office clerks\",\n  42, \"Customer services clerks\",\n  51, \"Personal and protective services workers\",\n  52, \"Models, salespersons and demonstrators\",\n  61, \"Market-oriented skilled agricultural and fishery workers\",\n  62, \"Subsistence agricultural and fishery workers\",\n  71, \"Extraction and building trades workers\",\n  72, \"Metal, machinery and related trades workers\",\n  73, \"Precision, handicraft, craft printing and related trades workers\",\n  74, \"Other craft and related trades workers\",\n  81, \"Stationary-plant and related operators\",\n  82, \"Machine operators and assemblers\",\n  83, \"Drivers and mobile-plant operators\",\n  91, \"Sales and services elementary occupations\",\n  92, \"Agricultural, fishery and related labourers\",\n  93, \"Labourers in mining, construction, manufacturing and transport\"\n)\n\ndata3 &lt;- data3 |&gt;\n  left_join(isco88_2digit, by = \"isco2\")"
  },
  {
    "objectID": "index.html#create-egp-schema",
    "href": "index.html#create-egp-schema",
    "title": "Replication Code",
    "section": "Create EGP Schema",
    "text": "Create EGP Schema\n\n\nShow code\n# install once\ninstall.packages(\"remotes\")\nremotes::install_github(\"pdparker/isco88conversion\")\n\nlibrary(isco88conversion)\n\ndata3$EGP &lt;- isco88conversion::convert(data3$ISCO88, type = \"EGP\")\n\negp_labels &lt;- c(\n  \"Higher-grade service class\",\n  \"Lower-grade service class\",\n  \"Routine non-manual workers\",\n  \"Small proprietors (non-agricultural)\",\n  \"Lower technicians / skilled manual supervisors\",\n  \"Self-employed\",\n  \"Skilled manual workers\",\n  \"Semi- and unskilled manual workers\",\n  \"Agricultural workers\",\n  \"Farmers\",\n  \"Agricultural self-employed\"\n)\n\ndata3$EGP_title &lt;- factor(\n  data3$EGP,\n  levels = 1:11,\n  labels = egp_labels\n)"
  },
  {
    "objectID": "index.html#weighted-coworker-measure",
    "href": "index.html#weighted-coworker-measure",
    "title": "Replication Code",
    "section": "Weighted Coworker Measure",
    "text": "Weighted Coworker Measure\n\n\nShow code\ndata4 &lt;- data3 |&gt; \n  filter(work == 1)\n## OF THOSE WHO WORK\n# BY CLASS\ndata4 |&gt;\n  group_by(sub_class) |&gt;\n  summarise(\n    avg_prop_cowork = 100*mean(weighted_cowork, na.rm = TRUE),\n    n = n()\n  )\n# more of a working and middle class pheonomenon (in terms of self-reported class identity)\n\n# BY 1-DIGIT OCC CODE\ndata4 |&gt;\n  group_by(isco1_title) |&gt;\n  summarise(\n    avg_prop_cowork = 100*mean(weighted_cowork, na.rm = TRUE),\n    n = n()\n  ) |&gt; \n  arrange(desc(avg_prop_cowork))\n\n\n\nBy ISCO 2 Digit\n\n\nShow code\ndata4 |&gt;\n  group_by(isco2_title) |&gt;\n  summarise(\n    avg_prop_cowork = 100*mean(weighted_cowork, na.rm = TRUE),\n    n = n()\n  ) |&gt; \n    arrange(desc(avg_prop_cowork))\n\n\n\n\nBy OCC 10\n\n\nShow code\ndata4 |&gt;\n  group_by(occ10_title) |&gt;\n  summarise(\n    avg_prop_cowork = 100 * mean(weighted_cowork, na.rm = TRUE),\n    n = n(),\n    .groups = \"drop\"\n  ) |&gt;\n  arrange(desc(avg_prop_cowork))\n\n\n\n\nBy EGP\n\n\nShow code\ndata4 |&gt;\n  group_by(EGP_title) |&gt;\n  summarise(\n    avg_prop_cowork = 100*mean(weighted_cowork, na.rm = TRUE),\n    n = n()\n  ) |&gt; \n    arrange(desc(avg_prop_cowork))"
  },
  {
    "objectID": "index.html#perceptions-of-job-loss",
    "href": "index.html#perceptions-of-job-loss",
    "title": "Replication Code",
    "section": "Perceptions of Job Loss",
    "text": "Perceptions of Job Loss\n\n\nShow code\ndata4 &lt;- data3 |&gt; \n  filter(work == 1)\n# BY CLASS\ndata4 |&gt;\n  group_by(sub_class) |&gt;\n  summarise(\n    avg_prop_cowork = mean(joblike_lose, na.rm = TRUE),\n    n = n()\n  )\n# BY OCCUPATION\ndata3 |&gt;\n  group_by(occ_major) |&gt;\n  summarise(\n    avg_prop_cowork = mean(joblike_lose, na.rm = TRUE),\n    n = n()\n  )"
  },
  {
    "objectID": "index.html#robustness-checks",
    "href": "index.html#robustness-checks",
    "title": "Replication Code",
    "section": "Robustness Checks",
    "text": "Robustness Checks\n\n\nShow code\n# Test Heteroskedasticity\nbptest(m2) # not heteroskedastic\nbptest(m1) # not heteroskedastic"
  },
  {
    "objectID": "index.html#final-table",
    "href": "index.html#final-table",
    "title": "Replication Code",
    "section": "Final Table",
    "text": "Final Table\n\n\nShow code\n# define models\nmodels &lt;- list(\n   \"Job Loss\" = m1_pure,\n  \"Job Loss\" = m1a,\n  \"Job Loss\" = m1b,\n   \"Job Security\" = m2_pure,\n  \"Job Security\" = m2a,\n  \"Job Security\" = m2b\n)\n\n# define variable names\ncoef_map &lt;- c(\n  \"weighted_cowork\" = \"Weighted coworker share\",\n  \"female\" = \"Female\",\n  \"age\" = \"Age\",\n  \"I(age^2)\" = \"Age squared\",\n  \"educ\" = \"Education\",\n  \"marital\" = \"Married\",\n  \"CHILDS\" = \"Children\",\n  \"hsincome\" = \"Household income\",\n  \"race\" = \"Race\",\n  \"rural\" = \"Rural\",\n  \"union\" = \"Union member\",\n  \"work_govt\" = \"Government worker\",\n  \"hrs_week\" = \"Hours worked per week\",\n  \"born\" = \"US-born\",\n  \"partyid\" = \"Party ID\"\n)\n\n# table\nmodelsummary(\n  models,\n # vcov = vcovHC,\n  statistic = \"std.error\",\n  coef_rename = coef_map,\n  stars = TRUE,\n  gof_omit = \"IC|Log|Adj|F\",\n output = \"latex\"\n)\n\n\n\n\nShow code\n# Descriptive table\n# Extract data actually used in the model\nmf &lt;- model.frame(m1)\n\n# Descriptives for numeric variables\ndescriptives &lt;- data.frame(\n  N    = sapply(mf, function(x) sum(!is.na(x))),\n  Mean = sapply(mf, function(x) if (is.numeric(x)) mean(x, na.rm = TRUE) else NA),\n  SD   = sapply(mf, function(x) if (is.numeric(x)) sd(x, na.rm = TRUE) else NA),\n  Min  = sapply(mf, function(x) if (is.numeric(x)) min(x, na.rm = TRUE) else NA),\n  Max  = sapply(mf, function(x) if (is.numeric(x)) max(x, na.rm = TRUE) else NA)\n)\n\ndescriptives"
  },
  {
    "objectID": "index.html#create-prompt",
    "href": "index.html#create-prompt",
    "title": "Replication Code",
    "section": "Create Prompt",
    "text": "Create Prompt\n\n\nShow code\nISCO_RULES &lt;- \"\nYou are a professional annotator of professions, and your task is to classify each position/job title into its actual ISCO-08 4 digit code and label.\n\nPlease follow these rules:\n1) If it says anything like scholarship or academic award (e.g. Fulbright), then don't give it an ISCO code but an NA. However, if someone clearly indicates that they are an ETA (English Teaching Assistant) or teacher, classify them accordingly.\n2) If someone is a current student or \\\"candidate\\\" (e.g. if the position includes \\\"major\\\" or BA/BS/BBA/MBA/J.D./MA or \\\"Master's\\\" etc.), then generally don't give them an ISCO code but also an NA. However, some people may include a previous degree in their position title even though they are currently working, so if you see a real job title in the position as well, then assign the ISCO code based on the occupation and disregard the university degree. Additionally, if you see that someone is a PhD or doctoral candidate, you can assume they are working and code their occupation based on the field of their PhD studies (likely somewhere within the 263 group).\n3) If you are unable to classify to the 4 digit level because of ambiguity but you can accurately map to the 3-digit level, then set isco4_code to NA but fill isco3_code and isco3_label.\n4) If it says self-employed or entrepreneur without a description of what the person is actually doing, set NA.\n5) If it says anything related to worship, assume they are a singer at a religious organization.\n6) If title is Spanish, translate to English internally and proceed.\n7) If someone is a researcher or \\\"fellow\\\" without specifying the field, place them in the university professor category. But if someone is a research assistant, place them within the 263 group if possible; try to classify to 4-digit using context clues.\n8) Try your best to find a 4 digit code for all observations, but do not force it. Prefer NA over an obviously wrong answer.\n\nReturn ONLY a single JSON object with these keys:\nisco4_code (string or null),\nisco4_label (string or null),\nisco3_code (string or null),\nisco3_label (string or null),\nposition_english (string),\nnotes (string).\n\""
  },
  {
    "objectID": "index.html#create-isco-08-translation-function",
    "href": "index.html#create-isco-08-translation-function",
    "title": "Replication Code",
    "section": "Create ISCO-08 Translation Function",
    "text": "Create ISCO-08 Translation Function\n\n\nShow code\n# Create function\nisco_code_one &lt;- function(position, company = NA_character_) {\n  # Clean inputs\n  position &lt;- position |&gt;  as.character() |&gt;  stringr::str_squish()\n  company  &lt;- company  |&gt;  as.character() |&gt;  stringr::str_squish()\n  if (is.na(company)) company &lt;- \"\"\n\n  prompt &lt;- paste0(\n    \"Classify this job title into ISCO-08.\\n\\n\",\n    \"POSITION: \", position, \"\\n\",\n    \"COMPANY: \", company, \"\\n\\n\",\n    \"Output JSON only.\"\n  )\n\n  r &lt;- httr2::request(\"https://api.openai.com/v1/chat/completions\") |&gt;\n    httr2::req_headers(\n      Authorization = paste(\"Bearer\", Sys.getenv(\"OPENAI_API_KEY\")),\n      `Content-Type` = \"application/json\"\n    ) |&gt;\n    httr2::req_body_json(list(\n      model = \"gpt-4o-mini\",\n      messages = list(\n        list(role = \"system\", content = ISCO_RULES),\n        list(role = \"user\", content = prompt)\n      ),\n      temperature = 0,\n      response_format = list(type = \"json_object\")\n    )) |&gt;\n    httr2::req_perform()\n  body &lt;- httr2::resp_body_json(r, simplifyVector = FALSE)\n  if (!is.null(body$error)) {\n    msg &lt;- body$error$message %||% \"Unknown OpenAI API error\"\n    stop(msg)\n  }\n  if (is.null(body$choices) || length(body$choices) == 0) {\n    stop(\"No choices returned by API\")\n  }\n\n  content &lt;- body$choices[[1]]$message$content\n  if (is.null(content) || !nzchar(content)) {\n    stop(\"Empty message content returned by API\")\n  }\n  parsed &lt;- jsonlite::fromJSON(content, simplifyVector = TRUE)\n\n  needed &lt;- c(\"isco4_code\",\"isco4_label\",\"isco3_code\",\"isco3_label\",\"position_english\",\"notes\")\n  for (k in needed) if (is.null(parsed[[k]])) parsed[[k]] &lt;- NA_character_\n\n  parsed\n}\n\n\n# Safeguard wrapper \nisco_code_safe &lt;- function(position, company = NA_character_) {\n  tryCatch(\n    isco_code_one(position, company),\n    error = function(e) {\n      warning(\"Failed for position: \", position, \" | Error: \", e$message)\n      return(list(\n        isco4_code = NA_character_,\n        isco4_label = NA_character_,\n        isco3_code = NA_character_,\n        isco3_label = NA_character_,\n        position_english = NA_character_,\n        notes = paste0(\"Error: \", e$message)\n      ))\n    }\n  )\n}"
  },
  {
    "objectID": "index.html#apply-function",
    "href": "index.html#apply-function",
    "title": "Replication Code",
    "section": "Apply Function",
    "text": "Apply Function\n\n\nShow code\n# Apply function to my data\nisco_code_df &lt;- function(df, position_col = \"Position\", company_col = \"Company\") {\n  if (!(position_col %in% names(df))) stop(\"Missing column: \", position_col)\n  if (!(company_col %in% names(df))) df[[company_col]] &lt;- \"\"\n\n  out_list &lt;- mapply(\n    FUN = function(pos, comp) isco_code_safe(pos, comp),\n    df[[position_col]],\n    df[[company_col]],\n    SIMPLIFY = FALSE\n  )\n\n  out_df &lt;- bind_rows(lapply(out_list, as.data.frame))\n\n  bind_cols(df, out_df)\n}\n\n# Run the data through the API \nresult &lt;- isco_code_df(df_panel, position_col = \"Position\", company_col = \"Company\")\n\n#save \n# write.csv(result, \"result.csv\", row.names = FALSE)"
  },
  {
    "objectID": "index.html#compare-results-to-manual-coding",
    "href": "index.html#compare-results-to-manual-coding",
    "title": "Replication Code",
    "section": "Compare Results to Manual Coding",
    "text": "Compare Results to Manual Coding\n\n\nShow code\n# Load manual coding\nresult &lt;- read_csv(\"\")\njobs_with_id &lt;- read_csv(\"\")\n\n# add ID to both for matching\nresult &lt;- result |&gt; \n  mutate(id = row_number())\njobs_with_id &lt;- jobs_with_id |&gt; \n  mutate(id = row_number())\n\n# merge datasets\njoined_df &lt;- jobs_with_id |&gt; \n  left_join(result, by = \"id\")\njoined_df &lt;- joined_df |&gt; \n  mutate(isco4_manual = `ISCO 4 digit`)\n\n#write.csv(joined_df, \"joined_df.csv\", row.names = FALSE)\n\n\n\n\nShow code\n# Calculate percent match\naccuracy_levels &lt;- joined_df |&gt; \n  mutate(\n    isco4_code   = str_squish(isco4_code),\n    isco4_manual = str_squish(isco4_manual)\n) |&gt; \n  filter(!is.na(isco4_code), !is.na(isco4_manual)) |&gt; \n  summarise(\n    accuracy_1digit = mean(substr(isco4_code, 1, 1) == substr(isco4_manual, 1, 1)) * 100,\n    accuracy_2digit = mean(substr(isco4_code, 1, 2) == substr(isco4_manual, 1, 2)) * 100,\n    accuracy_3digit = mean(substr(isco4_code, 1, 3) == substr(isco4_manual, 1, 3)) * 100,\n    accuracy_4digit = mean(isco4_code == isco4_manual) * 100,\n    n = n()\n  )\n\naccuracy_levels"
  }
]